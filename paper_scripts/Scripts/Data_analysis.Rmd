---
title: "Data_analysis"
author: "Magda Cardozo"
date: "19/11/2019"
output: html_document
---

## Load required libraries

```{r fun}
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggsignif))
suppressPackageStartupMessages(library(rcompanion))
```

## Load data
```{r data}
load("Abundances.RData")
```

### Bacterioplankton communities strongly change in cell abundance and composition with depth

## Significance of DAPI  with depth

```{r sigDAPIDpth}
counts_all%>% 
  group_by(Region, StationName, Depth) -> DAPI_sum 
#  summarise(mean.DAPI = mean(DAPI.conc.mn),
#            sd.dapi =se(DAPI.conc.mn))-> DAPI_sum

test4 <- wilcox.test(DAPI_sum[DAPI_sum$Depth == "SRF",]$DAPI.conc.mn,
            DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn)

p.adjust(test4$p.value, method = "bonferroni")

wilcoxonZ(DAPI_sum[DAPI_sum$Depth == "SRF",]$DAPI.conc.mn, #Calculates the z statistic 
            DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn,digits=4)

test5 <- wilcox.test(DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn,
            DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn)

p.adjust(test5$p.value, method = "bonferroni")

wilcoxonZ(DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn, #Calculates the z statistic 
            DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn,digits=4)

test6 <- wilcox.test(DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn,
            DAPI_sum[DAPI_sum$Depth == "BATHY",]$DAPI.conc.mn)

p.adjust(test6$p.value, method = "bonferroni")

wilcoxonZ(DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn, #Calculates the z statistic 
            DAPI_sum[DAPI_sum$Depth == "BATHY",]$DAPI.conc.mn,digits=4)
``` 

```{r sumDAPIDpth}
counts_all%>% 
  group_by(Region, StationName, Depth) %>%  
  summarise(mean.DAPI = mean(DAPI.conc.mn),
            sd.dapi =se(DAPI.conc.mn))-> DAPI_sum_R
DAPI_sum_R %>% 
  group_by(Region, Depth) %>% 
  summarise(dapimean = mean(mean.DAPI)/100000,
            sd.dapi =se(mean.DAPI)/100000)-> DAPI_sum_region

```

## Significance of Bacteria/Archaea with depth

```{r sigBACIDpth}
counts_all%>% 
  filter(Domain %in% c("ARCH"))%>% #change for other groups
  group_by(Region, StationName, Depth) -> ARCH_sum
#  summarise(mean.FISH = mean(FISH.conc.mn),
#            sd.FISH =se(FISH.conc.mn))-> EUB_sum

test7 <- wilcox.test(ARCH_sum[ARCH_sum$Depth == "SRF",]$FISH.conc.mn,
            ARCH_sum[ARCH_sum$Depth == "EPI",]$FISH.conc.mn)

p.adjust(test7$p.value, method = "bonferroni")

wilcoxonZ(ARCH_sum[ARCH_sum$Depth == "SRF",]$FISH.conc.mn,
            ARCH_sum[ARCH_sum$Depth == "EPI",]$FISH.conc.mn, digits = 4)

test8 <- wilcox.test(ARCH_sum[ARCH_sum$Depth == "EPI",]$FISH.conc.mn,
            ARCH_sum[ARCH_sum$Depth == "MESO",]$FISH.conc.mn)

p.adjust(test8$p.value, method = "bonferroni")

wilcoxonZ(ARCH_sum[ARCH_sum$Depth == "EPI",]$FISH.conc.mn,
            ARCH_sum[ARCH_sum$Depth == "MESO",]$FISH.conc.mn, digits = 4)

test9 <- wilcox.test(ARCH_sum[ARCH_sum$Depth == "MESO",]$FISH.conc.mn,
            ARCH_sum[ARCH_sum$Depth == "BATHY",]$FISH.conc.mn)

p.adjust(test9$p.value, method = "bonferroni")

wilcoxonZ(ARCH_sum[ARCH_sum$Depth == "MESO",]$FISH.conc.mn,
            ARCH_sum[ARCH_sum$Depth == "BATHY",]$FISH.conc.mn, digits = 4)
```


## Check the coverage of Bacteria and Archaea probes in comparison to DAPI

Coverage by probes
```{r covEA}
counts_all%>% 
  filter(Domain %in% c("EUB","ARCH"))%>%
  group_by(Region, StationName, Depth, Domain) %>% 
  summarise(proportion = FISH.conc.mn/DAPI.conc.mn)-> EUB_ARCH_prop
```

Total coverage
```{r covT}
EUB_ARCH_prop%>%
  group_by(Region, StationName, Depth) %>% 
  summarise(total.coverage = sum(proportion),
            sd.coverage = se(proportion)) -> EUB_ARCH_coverage
```

By regions
```{r covR}
EUB_ARCH_coverage %>%
  group_by(Region, Depth) %>% 
  summarise(mean.coverage = mean(total.coverage),
            sd.coverage = se(total.coverage)) -> EUB_ARCH_coverage_by_region
```

Proportions by depth
```{r covD}
EUB_ARCH_coverage %>%
  group_by(Depth) %>% 
  summarise(mean.coverage = mean(total.coverage),
            sd.coverage = se(total.coverage)) -> EUB_ARCH_coverage_by_depth
```            
            
## Siginificance tests proportions of Bacteria and Archaea by region (surface)
```{r sigProp}
EUB_ARCH_prop %>%
  filter(Domain %in% c("ARCH")) %>% #change here for EUB Bacteria
  filter(Depth %in% c("SRF"))%>%
  group_by(Region, StationName, Depth) -> ARCH_srf_cov
#  summarise(total.coverage = sum(proportion),
#            sd.coverage = se(proportion)) -> EUB_ARCH_coverage

test <- wilcox.test(ARCH_srf_cov[ARCH_srf_cov$Region == "WSC",]$proportion,
            ARCH_srf_cov[ARCH_srf_cov$Region == "N",]$proportion)

p.adjust(test$p.value, method = "bonferroni")

test2 <- wilcox.test(ARCH_srf_cov[ARCH_srf_cov$Region == "WSC",]$proportion,
            ARCH_srf_cov[ARCH_srf_cov$Region == "EGC",]$proportion)

p.adjust(test2$p.value, method = "bonferroni")

test3 <- wilcox.test(ARCH_srf_cov[ARCH_srf_cov$Region == "N",]$proportion,
            ARCH_srf_cov[ARCH_srf_cov$Region == "EGC",]$proportion)

p.adjust(test3$p.value, method = "bonferroni")
```  
## Significance of proportions by depth Bacteria Achaea

```{r sigPropDepth}
EUB_ARCH_prop %>%
  filter(Domain %in% c("ARCH")) %>% #change here for EUB Bacteria
  group_by(Region, StationName, Depth) -> ARCH_sum_prop

test7 <- wilcox.test(ARCH_sum_prop[ARCH_sum_prop$Depth == "SRF",]$proportion,
            ARCH_sum_prop[ARCH_sum_prop$Depth == "EPI",]$proportion)

p.adjust(test7$p.value, method = "bonferroni")

wilcoxonZ(ARCH_sum_prop[ARCH_sum_prop$Depth == "SRF",]$proportion,
            ARCH_sum_prop[ARCH_sum_prop$Depth == "EPI",]$proportion, digits = 4)

test8 <- wilcox.test(ARCH_sum_prop[ARCH_sum_prop$Depth == "EPI",]$proportion,
            ARCH_sum_prop[ARCH_sum_prop$Depth == "MESO",]$proportion)

p.adjust(test8$p.value, method = "bonferroni")

wilcoxonZ(ARCH_sum_prop[ARCH_sum_prop$Depth == "EPI",]$proportion,
            ARCH_sum_prop[ARCH_sum_prop$Depth == "MESO",]$proportion, digits = 4)

test9 <- wilcox.test(ARCH_sum_prop[ARCH_sum_prop$Depth == "MESO",]$proportion,
            ARCH_sum_prop[ARCH_sum_prop$Depth == "BATHY",]$proportion)

p.adjust(test9$p.value, method = "bonferroni")

wilcoxonZ(ARCH_sum_prop[ARCH_sum_prop$Depth == "MESO",]$proportion,
            ARCH_sum_prop[ARCH_sum_prop$Depth == "BATHY",]$proportion, digits = 4)
```

### Surface water bacterioplankton communities are affected by distinct phytoplankton bloom conditions across the Fram Strait 

## Significance of surface DAPI between regions

```{r sigDAPIReg}
counts_all%>% 
  filter(Depth %in% c("SRF"))%>% #change here to test other depths
  group_by(Region, StationName, Depth) -> DAPI_sum_srf 
  #summarise(mean.DAPI = mean(DAPI.conc.mn),
  #          sd.dapi =se(DAPI.conc.mn))

test13 <- wilcox.test(DAPI_sum_srf[DAPI_sum_srf$Region == "WSC",]$DAPI.conc.mn,
            DAPI_sum_srf[DAPI_sum_srf$Region == "N",]$DAPI.conc.mn)

p.adjust(test13$p.value, method = "bonferroni")

test14 <- wilcox.test(DAPI_sum_srf[DAPI_sum_srf$Region == "EGC",]$DAPI.conc.mn,
            DAPI_sum_srf[DAPI_sum_srf$Region == "N",]$DAPI.conc.mn)

p.adjust(test14$p.value, method = "bonferroni")

test15 <- wilcox.test(DAPI_sum_srf[DAPI_sum_srf$Region == "WSC",]$DAPI.conc.mn,
            DAPI_sum_srf[DAPI_sum_srf$Region == "EGC",]$DAPI.conc.mn)

p.adjust(test15$p.value, method = "bonferroni")

```

## Significance of groups between the regions 

Change Domain to see different groups
```{r sigGrReg}
counts_all%>% 
  filter(Domain %in% c("SAR11"))%>% #change here for Bacteroidia, Gammaproteobacteria and verrucomicrobia, Deltaproteobacteria and Thaumarcheota
  filter(Depth %in% c("SRF"))%>%  
  group_by(Region, StationName, Depth) -> SAR11_sum 
#  summarise(mean.FISH = mean(FISH.conc.mn),
#            sd.FISH =se(FISH.conc.mn))-> SAR202_sum

test10 <- wilcox.test(SAR11_sum[SAR11_sum$Region == "EGC",]$FISH.conc.mn,
            SAR11_sum[SAR11_sum$Region == "N",]$FISH.conc.mn)

p.adjust(test10$p.value, method = "bonferroni")

test11 <- wilcox.test(SAR11_sum[SAR11_sum$Region == "EGC",]$FISH.conc.mn,
            SAR11_sum[SAR11_sum$Region == "WSC",]$FISH.conc.mn)

p.adjust(test11$p.value, method = "bonferroni")

test12 <- wilcox.test(SAR11_sum[SAR11_sum$Region == "N",]$FISH.conc.mn,
            SAR11_sum[SAR11_sum$Region == "WSC",]$FISH.conc.mn)

p.adjust(test12$p.value, method = "bonferroni")

```



## Overview of phylogenetic group abundances by regions

Calculate abundance in surface by region
```{r FISH}
counts_all%>% 
  filter(Depth == "EPI")%>%
  group_by(Region, Domain) %>%
  summarise(mean.abund = mean(FISH.conc.mn),
            se.abund = se(FISH.conc.mn),
            n= length(FISH.conc.mn))-> FISH_abundance_surface_by_region
```

Make wide table
```{r FISHw}
FISH_abundance_surface_by_region %>%
  select(Region,Domain,mean.abund)%>%
  spread(Region,mean.abund) -> FISH_abundance_surface_by_region_wide
```

Calculate abundances by region
```{r FISHreg}
counts_all%>% 
  group_by(Region, Domain, Depth) %>%
  summarise(mean.abund = mean(FISH.conc.mn)/100000,
            se.abund = se(FISH.conc.mn)/100000,
            n= sum(n))-> FISH_abundances_by_region

FISH_abundances_by_region$Depth <- factor(FISH_abundances_by_region$Depth, levels = c("SRF","EPI","MESO","BATHY"))
FISH_abundances_by_region %>%
  select(Region,Domain,Depth,mean.abund)%>%
  spread(Domain,mean.abund) -> FISH_abundance_by_region_wide

FISH_and_dapi_abundance_by_region_w <- left_join(
  DAPI_sum_region[, c("Region", "Depth", "dapimean")],
  FISH_abundance_by_region_wide,
  by = c("Region", "Depth"))

#write.csv(FISH_and_dapi_abundance_by_region_w, file="~/CARD-FISH/CARD-FISH_water_project/cell_densities.csv")
```

Calculate proportional abundance of the different groups at the surface
```{r FISHSRF}
counts_all%>% 
  filter(Depth %in% c("SRF"))%>%
  #left_join(.,total_abundance_surface_by_station[,c("StationName","total.abund")], by = "StationName") %>%
  group_by(Region, Depth, StationName, Domain)%>%
  mutate(proportion = (FISH.conc.mn / DAPI.conc.mn)*100) %>%
  select(Region, StationName, Domain, FISH.conc.mn, proportion)  -> surface_FISH_proportion
```

Summarize by regions
```{r FSRFreg}
surface_FISH_proportion%>%
  group_by(Region, Domain) %>% 
  summarise (mean.abund = mean(FISH.conc.mn),
             se.abund = se(FISH.conc.mn), 
             mean.prop = mean(proportion),
             se.prop = se(proportion)) -> surface_FISH_proportion_by_regions
```

Calculate proportional abundance of the different groups
```{r FSRFgr}
counts_all%>% 
  group_by(Region, StationName, Domain)%>%
  mutate(proportion = (FISH.conc.mn / DAPI.conc.mn)*100) %>%
  group_by(Region, Domain, Depth) %>%
  summarise(mean.prop = mean(proportion),
            se.prop = se(proportion))%>%
  select(Region, Domain, mean.prop, Depth) %>%
  spread(Domain,mean.prop) ->  FISH_proportion

#write.csv(FISH_proportion, file="~/CARD-FISH/CARD-FISH_water_project/cell_prortions.csv")
```  
 
## Save image
```{r save2}
save.image("Data_analysis.RData")
```