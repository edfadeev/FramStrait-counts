---
title: "FISH_correlations"
author: "Magda Cardozo"
date: "18/11/2019"
output: html_document
---

## Load required libraries

```{r }
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(PerformanceAnalytics))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(broom))
```

## Load data
```{r data}
load("Abundances.RData")
metadata.raw <- read.csv("./PS99_metadata.csv", sep = ",", dec = ".", header = TRUE)
```

## Defined functions
```{r fn}
#scale parameters
scale_par <- function(x) scale(x, center = FALSE, scale = TRUE)[,1]

#define function for correlation 
cor_fun <- function(df) cor.test(df$Abund, df$value, method = "pearson",conf.level = 0.95) %>% tidy()
```

## Env. parameter coorelation test 

List environmental parameters that need to be scaled
```{r envpar}
env.par <- c("Temperature","Salinity", 
             "Chla_fluor", "d.NO3.", "d.NH4.", "d.PO4.", "d.SiO3.")
```

Remove station SV2 from the dataset, drop rows with NA and scale the env. parameters 
```{r scl}
metadata.scaled <- drop_na(metadata.raw) %>% 
  mutate_at(env.par, scale_par)
```

Calculate the Pearsonâ€™s correlation coefficient in a matrix
```{r cor}
chart.Correlation(metadata.scaled[,env.par], method = "pearson", histogram=TRUE, pch=19)
```

## Correlation between environmental parameters and counts

list all taxa 
```{r tax}
taxa <- c("EUB", "ARCH", "ALT", "BACT", "CFX", "CREN", "DELTA", "GAM", "OPI", "POL", "ROS", "SAR11", "SAR202","SAR324", "SAR406", "VER")
```

Select only surface samples
```{r srf}
metadata.scaled %>%
  filter (Depth == "SRF") -> metadata.scaled.SRF
```

Generate wide abundance table and environmental parameters
```{r wtbl}
data_all <- counts_all%>% 
  filter(Depth %in% c("SRF"))%>%
  group_by(Region, StationName, Domain)%>%
  select(Region, StationName, Domain, FISH.conc.mn)  %>% 
  spread(Domain, FISH.conc.mn)  %>%
#drop samples with no env. data
  filter(StationName %in% metadata.scaled.SRF$StationName) %>% 
#merge counts and environmental data
left_join(., metadata.scaled.SRF[,c("StationName",env.par)] , by = "StationName")
```

Generate long table and nest the table according to taxa and env. variable
```{r nst}
data_nest <- gather(data_all, Domain, Abund, taxa)%>%
  gather(variable, value, env.par) %>% 
  group_by(Domain, variable) %>% nest()
```

Nested correlations tests
```{r nstcor}
data_nest <- mutate(data_nest, model = map(data, cor_fun))
```

Summary table
```{r sumtbl}
corr_pr.sign <- select(data_nest, -data) %>% unnest() %>% 
  #extract only significant results 
              filter(p.value < 0.05)
write.csv(corr_pr.sign, "./corr_table.csv")
```

