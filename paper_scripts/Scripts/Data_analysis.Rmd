---
title: "Data_analysis"
author: "Magda Cardozo"
date: "19/11/2019"
output: html_document
---

## Load required libraries

```{r fun}
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggsignif))
suppressPackageStartupMessages(library(rcompanion))
```

## Load data
```{r data}
load("Abundances.RData")
```

## Check the coverage of Bacteria and Archaea probes in comparison to DAPI

Coverage by probes
```{r covEA}
counts_all%>% 
  filter(Domain %in% c("EUB","ARCH"))%>%
  group_by(Region, StationName, Depth, Domain) %>% 
  summarise(proportion = FISH.conc.mn/DAPI.conc.mn)-> EUB_ARCH_prop
```

Total coverage
```{r covT}
EUB_ARCH_prop%>%
  group_by(Region, StationName, Depth) %>% 
  summarise(total.coverage = sum(proportion),
            sd.coverage = se(proportion)) -> EUB_ARCH_coverage
```

By regions
```{r covR}
EUB_ARCH_coverage %>%
  group_by(Region, Depth) %>% 
  summarise(mean.coverage = mean(total.coverage),
            sd.coverage = se(total.coverage)) -> EUB_ARCH_coverage_by_region
```

Proportions by depth
```{r covD}
EUB_ARCH_coverage %>%
  group_by(Depth) %>% 
  summarise(mean.coverage = mean(total.coverage),
            sd.coverage = se(total.coverage)) -> EUB_ARCH_coverage_by_depth
```            
            
Siginificance tests
```{r sigProp}
EUB_ARCH_prop%>%
  group_by(Region, StationName, Depth) -> EUB_ARCH_cov
#  summarise(total.coverage = sum(proportion),
#            sd.coverage = se(proportion)) -> EUB_ARCH_coverage

wilcox.test(EUB_ARCH_cov[EUB_ARCH_cov$Region == "WSC",]$proportion,
            EUB_ARCH_cov[EUB_ARCH_cov$Region == "N",]$proportion)

wilcox.test(EUB_ARCH_cov[EUB_ARCH_cov$Region == "WSC",]$proportion,
            EUB_ARCH_cov[EUB_ARCH_cov$Region == "EGC",]$proportion)

wilcox.test(EUB_ARCH_cov[EUB_ARCH_cov$Region == "N",]$proportion,
            EUB_ARCH_cov[EUB_ARCH_cov$Region == "EGC",]$proportion)
```  

## Significance of DAPI  with depth

```{r sigDAPIDpth}
counts_all%>% 
  group_by(Region, StationName, Depth) -> DAPI_sum 
#  summarise(mean.DAPI = mean(DAPI.conc.mn),
#            sd.dapi =se(DAPI.conc.mn))-> DAPI_sum

wilcox.test(DAPI_sum[DAPI_sum$Depth == "SRF",]$DAPI.conc.mn,
            DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn)

wilcoxonZ(DAPI_sum[DAPI_sum$Depth == "SRF",]$DAPI.conc.mn, #Calculates the z statistic 
            DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn,digits=4)

wilcox.test(DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn,
            DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn)

wilcoxonZ(DAPI_sum[DAPI_sum$Depth == "EPI",]$DAPI.conc.mn, #Calculates the z statistic 
            DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn,digits=4)

wilcox.test(DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn,
            DAPI_sum[DAPI_sum$Depth == "BATHY",]$DAPI.conc.mn)

wilcoxonZ(DAPI_sum[DAPI_sum$Depth == "MESO",]$DAPI.conc.mn, #Calculates the z statistic 
            DAPI_sum[DAPI_sum$Depth == "BATHY",]$DAPI.conc.mn,digits=4)
``` 

```{r sumDAPIDpth}
DAPI_sum %>% 
  group_by(Region, Depth) %>% 
  summarise(dapimean = mean(mean.DAPI)/100000,
            sd.dapi =se(mean.DAPI)/100000)-> DAPI_sum_region

```

## Significance of Bacteria/Archaea with depth

```{r sigBACIDpth}
counts_all%>% 
  filter(Domain %in% c("EUB"))%>% #change for ARCH
  group_by(Region, StationName, Depth) -> EUB_sum
#  summarise(mean.FISH = mean(FISH.conc.mn),
#            sd.FISH =se(FISH.conc.mn))-> EUB_sum

wilcox.test(EUB_sum[EUB_sum$Depth == "SRF",]$FISH.conc.mn,
            EUB_sum[EUB_sum$Depth == "EPI",]$FISH.conc.mn)

wilcoxonZ(EUB_sum[EUB_sum$Depth == "SRF",]$FISH.conc.mn,
            EUB_sum[EUB_sum$Depth == "EPI",]$FISH.conc.mn, digits = 4)

wilcox.test(EUB_sum[EUB_sum$Depth == "EPI",]$FISH.conc.mn,
            EUB_sum[EUB_sum$Depth == "MESO",]$FISH.conc.mn)

wilcoxonZ(EUB_sum[EUB_sum$Depth == "EPI",]$FISH.conc.mn,
            EUB_sum[EUB_sum$Depth == "MESO",]$FISH.conc.mn, digits = 4)

wilcox.test(EUB_sum[EUB_sum$Depth == "MESO",]$FISH.conc.mn,
            EUB_sum[EUB_sum$Depth == "BATHY",]$FISH.conc.mn)

wilcoxonZ(EUB_sum[EUB_sum$Depth == "MESO",]$FISH.conc.mn,
            EUB_sum[EUB_sum$Depth == "BATHY",]$FISH.conc.mn, digits = 4)
```

## Significance of groups between the regions 

Change Domain to see different groups
```{r sigGrReg}
counts_all%>% 
  filter(Domain %in% c("SAR202"))%>% #change domain for different groups
  filter(Depth %in% c("SRF"))%>%  #change here for different depths
  group_by(Region, StationName, Depth) -> SAR202_sum 
#  summarise(mean.FISH = mean(FISH.conc.mn),
#            sd.FISH =se(FISH.conc.mn))-> SAR202_sum

wilcox.test(SAR202_sum[SAR202_sum$Region == "EGC",]$FISH.conc.mn,
            SAR202_sum[SAR202_sum$Region == "N",]$FISH.conc.mn)

wilcox.test(SAR202_sum[SAR202_sum$Region == "EGC",]$FISH.conc.mn,
            SAR202_sum[SAR202_sum$Region == "WSC",]$FISH.conc.mn)

wilcox.test(SAR202_sum[SAR202_sum$Region == "N",]$FISH.conc.mn,
            SAR202_sum[SAR202_sum$Region == "WSC",]$FISH.conc.mn)

```

## Significance of depht DAPI between regions

```{r sigDAPIReg}
counts_all%>% 
  filter(Depth %in% c("SRF"))%>%
  group_by(Region, StationName, Depth) -> DAPI_sum_srf 
  #summarise(mean.DAPI = mean(DAPI.conc.mn),
  #          sd.dapi =se(DAPI.conc.mn))

wilcox.test(DAPI_sum_srf[DAPI_sum_srf$Region == "WSC",]$DAPI.conc.mn,
            DAPI_sum_srf[DAPI_sum_srf$Region == "N",]$DAPI.conc.mn)

wilcox.test(DAPI_sum_srf[DAPI_sum_srf$Region == "EGC",]$DAPI.conc.mn,
            DAPI_sum_srf[DAPI_sum_srf$Region == "N",]$DAPI.conc.mn)

wilcox.test(DAPI_sum_srf[DAPI_sum_srf$Region == "WSC",]$DAPI.conc.mn,
            DAPI_sum_srf[DAPI_sum_srf$Region == "EGC",]$DAPI.conc.mn)

```

## Overview of phylogenetic group abundances by regions

Calculate abundance in surface by region
```{r FISH}
counts_all%>% 
  filter(Depth == "EPI")%>%
  group_by(Region, Domain) %>%
  summarise(mean.abund = mean(FISH.conc.mn),
            se.abund = se(FISH.conc.mn),
            n= length(FISH.conc.mn))-> FISH_abundance_surface_by_region
```

Make wide table
```{r FISHw}
FISH_abundance_surface_by_region %>%
  select(Region,Domain,mean.abund)%>%
  spread(Region,mean.abund) -> FISH_abundance_surface_by_region_wide
```

Calculate abundances by region
```{r FISHreg}
counts_all%>% 
  group_by(Region, Domain, Depth) %>%
  summarise(mean.abund = mean(FISH.conc.mn)/100000,
            se.abund = se(FISH.conc.mn)/100000,
            n= sum(n))-> FISH_abundances_by_region

FISH_abundances_by_region$Depth <- factor(FISH_abundances_by_region$Depth, levels = c("SRF","EPI","MESO","BATHY"))
FISH_abundances_by_region %>%
  select(Region,Domain,Depth,mean.abund)%>%
  spread(Domain,mean.abund) -> FISH_abundance_by_region_wide

FISH_and_dapi_abundance_by_region_w <- left_join(
  DAPI_sum_region[, c("Region", "Depth", "dapimean")],
  FISH_abundance_by_region_wide,
  by = c("Region", "Depth"))

#write.csv(FISH_and_dapi_abundance_by_region_w, file="~/CARD-FISH/CARD-FISH_water_project/cell_densities.csv")
```

Calculate proportional abundance of the different groups at the surface
```{r FISHSRF}
counts_all%>% 
  filter(Depth %in% c("SRF"))%>%
  #left_join(.,total_abundance_surface_by_station[,c("StationName","total.abund")], by = "StationName") %>%
  group_by(Region, Depth, StationName, Domain)%>%
  mutate(proportion = (FISH.conc.mn / DAPI.conc.mn)*100) %>%
  select(Region, StationName, Domain, FISH.conc.mn, proportion)  -> surface_FISH_proportion
```

Summarize by regions
```{r FSRFreg}
surface_FISH_proportion%>%
  group_by(Region, Domain) %>% 
  summarise (mean.abund = mean(FISH.conc.mn),
             se.abund = se(FISH.conc.mn), 
             mean.prop = mean(proportion),
             se.prop = se(proportion)) -> surface_FISH_proportion_by_regions
```

Calculate proportional abundance of the different groups
```{r FSRFgr}
counts_all%>% 
  group_by(Region, StationName, Domain)%>%
  mutate(proportion = (FISH.conc.mn / DAPI.conc.mn)*100) %>%
  group_by(Region, Domain, Depth) %>%
  summarise(mean.prop = mean(proportion),
            se.prop = se(proportion))%>%
  select(Region, Domain, mean.prop, Depth) %>%
  spread(Domain,mean.prop) ->  FISH_proportion

#write.csv(FISH_proportion, file="~/CARD-FISH/CARD-FISH_water_project/cell_prortions.csv")
```  
 
 